<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microlearning Mission Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        let state = {
            apiKey: '',
            apiProvider: 'openai',
            topic: '',
            audience: '',
            objective: '',
            context: '',
            mission: null,
            generating: false
        };

        function render() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen">
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 text-white py-6 px-8">
                        <div class="max-w-5xl mx-auto">
                            <h1 class="text-3xl font-bold">Microlearning Mission Generator</h1>
                            <p class="text-indigo-100 mt-1">Create 3-5 minute online learning modules</p>
                        </div>
                    </div>
                    <div class="max-w-5xl mx-auto p-8">
                        ${state.mission ? renderMission() : renderForm()}
                    </div>
                </div>
            `;
            attachListeners();
        }

        function renderForm() {
            return `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="provider" class="px-4 py-2 border rounded">
                            <option value="openai" ${state.apiProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                            <option value="anthropic" ${state.apiProvider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                        </select>
                        <input type="password" id="apiKey" value="${state.apiKey}" placeholder="API Key *" class="px-4 py-2 border rounded">
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Mission Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Topic / Title *</label>
                            <input type="text" id="topic" value="${state.topic}" placeholder="e.g., 5S Workplace Organization" class="w-full px-4 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Target Audience *</label>
                            <input type="text" id="audience" value="${state.audience}" placeholder="e.g., Warehouse supervisors" class="w-full px-4 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Learning Objective *</label>
                            <input type="text" id="objective" value="${state.objective}" placeholder="What should learners be able to do?" class="w-full px-4 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Key Context & Background</label>
                            <textarea id="context" rows="4" placeholder="Industry, challenges, regulations..." class="w-full px-4 py-2 border rounded">${state.context}</textarea>
                        </div>
                    </div>
                    <button onclick="generate()" ${state.generating ? 'disabled' : ''} 
                            class="mt-6 w-full py-4 bg-indigo-900 text-white rounded-lg font-semibold disabled:opacity-50">
                        ${state.generating ? 'Generating...' : 'Generate Mission'}
                    </button>
                </div>
            `;
        }

        function renderMission() {
            const m = state.mission;
            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-indigo-800">
                        <div class="flex justify-between mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-indigo-900">Mission Generated</h2>
                                <p class="text-gray-600">${m.slides.length} slides | ${Math.round(m.slides.length * 37.5 / 60 * 10) / 10} min</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="newMission()" class="px-4 py-2 bg-gray-600 text-white rounded">New</button>
                                <button onclick="downloadJSON()" class="px-4 py-2 bg-blue-600 text-white rounded">JSON</button>
                                <button onclick="downloadText()" class="px-4 py-2 bg-green-600 text-white rounded">Text</button>
                                <button onclick="downloadCSV()" class="px-4 py-2 bg-purple-600 text-white rounded">CSV</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-400">
                        <h3 class="text-xl font-bold mb-3">${m.mission_title}</h3>
                        <div class="bg-gray-50 p-4 rounded mb-4">
                            <h4 class="font-semibold mb-2">Introduction</h4>
                            <p class="text-sm">${m.introduction}</p>
                        </div>
                        <h4 class="font-semibold mb-2">Slide Outline</h4>
                        <table class="w-full text-sm border mb-4">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border p-2">Slide</th>
                                    <th class="border p-2">Title</th>
                                    <th class="border p-2">Bullets</th>
                                    <th class="border p-2">Voice-Over Prompt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${m.slides.map((s, i) => `
                                    <tr>
                                        <td class="border p-2">${i + 1}</td>
                                        <td class="border p-2 font-medium">${s.title}</td>
                                        <td class="border p-2">${s.bullets.join('<br>')}</td>
                                        <td class="border p-2 text-gray-600">${s.voiceover_prompt}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded">
                                <h4 class="font-semibold mb-2">Learner Steps</h4>
                                <ul class="text-sm space-y-1">
                                    ${m.learner_steps.map(s => `<li>• ${s}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="bg-green-50 p-4 rounded">
                                <h4 class="font-semibold mb-2">Habits</h4>
                                <ul class="text-sm space-y-1">
                                    ${m.habits.daily ? `<li>• <strong>Daily:</strong> ${m.habits.daily}</li>` : ''}
                                    ${m.habits.weekly ? `<li>• <strong>Weekly:</strong> ${m.habits.weekly}</li>` : ''}
                                    ${m.habits.monthly ? `<li>• <strong>Monthly:</strong> ${m.habits.monthly}</li>` : ''}
                                    ${m.habits.quarterly ? `<li>• <strong>Quarterly:</strong> ${m.habits.quarterly}</li>` : ''}
                                </ul>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded mb-4">
                            <h4 class="font-semibold mb-2">Chat Prompt</h4>
                            <p class="text-sm">${m.chat_prompt}</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded">
                            <h4 class="font-semibold mb-2">Mentor Questions</h4>
                            <ul class="text-sm space-y-1">
                                ${m.mentor_questions.map(q => `<li>• ${q}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachListeners() {
            const provider = document.getElementById('provider');
            const apiKey = document.getElementById('apiKey');
            const topic = document.getElementById('topic');
            const audience = document.getElementById('audience');
            const objective = document.getElementById('objective');
            const context = document.getElementById('context');

            if (provider) provider.onchange = e => { state.apiProvider = e.target.value; };
            if (apiKey) apiKey.oninput = e => { state.apiKey = e.target.value; };
            if (topic) topic.oninput = e => { state.topic = e.target.value; };
            if (audience) audience.oninput = e => { state.audience = e.target.value; };
            if (objective) objective.oninput = e => { state.objective = e.target.value; };
            if (context) context.oninput = e => { state.context = e.target.value; };
        }

        async function generate() {
            if (!state.apiKey || !state.topic || !state.audience || !state.objective) {
                alert('Fill required fields');
                return;
            }

            state.generating = true;
            render();

            const prompt = `Create a microlearning mission for online delivery.

Topic: ${state.topic}
Audience: ${state.audience}
Objective: ${state.objective}
${state.context ? `Context: ${state.context}` : ''}

Requirements: 3-5 min, 12-18 slides at 30-45 sec each. Voice-over prompts are questions, not scripts.

Return JSON:
{
  "mission_title": "...",
  "introduction": "2-3 sentences",
  "slides": [{"slide_number": 1, "title": "...", "bullets": ["..."], "voiceover_prompt": "question?"}],
  "learner_steps": ["..."],
  "chat_prompt": "...",
  "mentor_questions": ["..."],
  "habits": {"daily": "...", "weekly": "...", "monthly": null, "quarterly": null}
}`;

            try {
                const url = state.apiProvider === 'openai' 
                    ? 'https://api.openai.com/v1/chat/completions'
                    : 'https://api.anthropic.com/v1/messages';
                
                const headers = state.apiProvider === 'openai'
                    ? {'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}`}
                    : {'Content-Type': 'application/json', 'x-api-key': state.apiKey, 'anthropic-version': '2023-06-01'};
                
                const body = state.apiProvider === 'openai'
                    ? {model: 'gpt-4o', messages: [{role: 'user', content: prompt}]}
                    : {model: 'claude-sonnet-4-20250514', max_tokens: 4096, messages: [{role: 'user', content: prompt}]};

                const res = await fetch(url, {method: 'POST', headers, body: JSON.stringify(body)});
                const data = await res.json();
                let content = state.apiProvider === 'openai' ? data.choices[0].message.content : data.content[0].text;
                content = content.trim().replace(/^```json\n?/, '').replace(/\n?```$/, '');
                state.mission = JSON.parse(content);
                state.generating = false;
                render();
            } catch (error) {
                alert('Error: ' + error.message);
                state.generating = false;
                render();
            }
        }

        function newMission() {
            state.mission = null;
            render();
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(state.mission, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.mission.mission_title.replace(/\s+/g, '_')}.json`;
            a.click();
        }

        function downloadText() {
            let txt = `${state.mission.mission_title}\n\nIntroduction\n${state.mission.introduction}\n\nSlides\n`;
            state.mission.slides.forEach((s, i) => {
                txt += `${i + 1}\t${s.title}\t${s.bullets.join('\n')}\t${s.voiceover_prompt}\n`;
            });
            txt += `\nSteps\n${state.mission.learner_steps.map(s => '• ' + s).join('\n')}\n`;
            txt += `\nChat\n${state.mission.chat_prompt}\n\nQuestions\n${state.mission.mentor_questions.map(q => '• ' + q).join('\n')}\n`;
            const blob = new Blob([txt], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.mission.mission_title.replace(/\s+/g, '_')}.txt`;
            a.click();
        }

        function downloadCSV() {
            const csv = ['Slide,Title,Bullets,Prompt', 
                ...state.mission.slides.map((s, i) => `${i + 1},"${s.title}","${s.bullets.join(' | ')}","${s.voiceover_prompt}"`)
            ].join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.mission.mission_title.replace(/\s+/g, '_')}.csv`;
            a.click();
        }

        render();
    </script>
</body>
</html>
